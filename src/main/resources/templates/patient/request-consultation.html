<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Consultation</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .consultation-card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1 );
            margin-bottom: 20px;
        }
        .consultation-type-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .consultation-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .consultation-type-card.active {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .doctor-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .doctor-card:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .doctor-card.selected {
            background-color: #e7f1ff;
            border-color: #0d6efd;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        .step.active .step-number {
            background-color: #0d6efd;
            color: white;
        }
        .step.completed .step-number {
            background-color: #198754;
            color: white;
        }
        .step-line {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: #e9ecef;
            z-index: -1;
        }
        .symptom-tag {
            display: inline-block;
            background-color: #e9ecef;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .symptom-tag:hover {
            background-color: #dee2e6;
        }
        .symptom-tag.selected {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" th:href="@{/patient/dashboard}">
            <i class="fas fa-heartbeat text-primary"></i> TéléMédecine
        </a>
        <div class="d-flex align-items-center">
            <span class="me-3" th:text="${patient.name}">Patient Name</span>
            <a th:href="@{/patient/dashboard}" class="btn btn-outline-primary">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-title">Choose Doctor</div>
            <div class="step-line"></div>
        </div>
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-title">Select Type</div>
            <div class="step-line"></div>
        </div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-title">Add Details</div>
            <div class="step-line"></div>
        </div>
        <div class="step" id="step4">
            <div class="step-number">4</div>
            <div class="step-title">Review</div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i>
        <span th:text="${param.success == 'requestSubmitted' ? 'Consultation request submitted successfully!' : param.success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i>
        <span th:text="${param.error == 'requestFailed' ? 'Failed to submit consultation request. Please try again.' : param.error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Consultation Request Form -->
    <form th:action="@{/patient/consultation/request}" method="post" id="consultationForm">
        <div class="card consultation-card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-calendar-plus"></i> Request New Consultation</h4>
            </div>
            <div class="card-body">

                <!-- Step 1: Select Doctor -->
                <div id="step1-content" class="step-content">
                    <h5 class="mb-4">Select a Doctor</h5>
                    <div class="row">
                        <div class="col-md-6" th:each="doctor : ${doctors}">
                            <div class="doctor-card"
                                 th:data-doctor-id="${doctor.id}"
                                 th:data-doctor-name="${doctor.name}"
                                 onclick="selectDoctor(this)">                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                             style="width: 60px; height: 60px; font-size: 24px;">
                                            DR
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1" th:text="'Dr. ' + ${doctor.name}">Dr. Name</h6>
                                        <p class="text-muted mb-1" th:text="${doctor.specialte}">Specialization</p>
                                        <small class="text-success">
                                            <i class="fas fa-clock"></i> Available
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="doctorId" name="doctorId" th:value="${selectedDoctor != null ? selectedDoctor.id : ''}">
                </div>

                <!-- Step 2: Consultation Type -->
                <div id="step2-content" class="step-content" style="display: none;">
                    <h5 class="mb-4">Select Consultation Type</h5>
                    <div class="row">
                        <div class="col-md-3 mb-3" th:each="type : ${consultationTypes}">
                            <div class="card consultation-type-card text-center"
                                 th:data-type="${type.name()}" onclick="selectType(this)">

                            <div class="card-body">
                                <div class="mb-3">
                                    <i class="fas"
                                       th:classappend="${type.name() == 'VIDEO_CALL'} ? 'fa-video' :
                                          (${type.name() == 'TEXT_CHAT'} ? 'fa-comments' :
                                          (${type.name() == 'VOICE_CALL'} ? 'fa-phone' : 'fa-user-md'))"
                                       style="font-size: 2rem; color: #0d6efd;"></i>
                                </div>
                                <h6 th:text="${type.name() == 'VIDEO_CALL'} ? 'Video Call' :
                                 (${type.name() == 'TEXT_CHAT'} ? 'Text Chat' :
                                 (${type.name() == 'VOICE_CALL'} ? 'Voice Call' : 'In Person'))">
                                    Type
                                </h6>
                                <p class="text-muted small mb-0">
                                    <span th:if="${type.name() == 'VIDEO_CALL'}">Face-to-face video consultation</span>
                                    <span th:if="${type.name() == 'TEXT_CHAT'}">Text-based messaging consultation</span>
                                    <span th:if="${type.name() == 'VOICE_CALL'}">Audio-only consultation</span>
                                    <span th:if="${type.name() == 'IN_PERSON'}">Physical office visit</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="consultationType" name="consultationType">
            </div>

                <!-- Step 3: Details -->
                <div id="step3-content" class="step-content" style="display: none;">
                    <h5 class="mb-4">Add Consultation Details</h5>

                    <!-- Reason -->
                    <div class="mb-3">
                        <label for="reason" class="form-label">
                            <i class="fas fa-stethoscope"></i> Reason for Consultation *
                        </label>
                        <textarea class="form-control" id="reason" name="reason"
                                  rows="3" placeholder="Describe why you need this consultation..."
                                  required></textarea>
                    </div>

                    <!-- Common Symptoms -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-thermometer-half"></i> Common Symptoms (Optional)
                        </label>
                        <div id="symptoms-container">
                            <span class="symptom-tag" onclick="toggleSymptom(this)">Fever</span>
                            <span class="symptom-tag" onclick="toggleSymptom(this)">Headache</span>
                            <span class="symptom-tag" onclick="toggleSymptom(this)">Cough</span>
                            <span class="symptom-tag" onclick="toggleSymptom(this)">Fatigue</span>
                            <span class="symptom-tag" onclick="toggleSymptom(this)">Nausea</span>
                            <span class="symptom-tag" onclick="toggleSymptom(this)">Sore Throat</span>
                        </div>
                        <input type="hidden" id="symptoms" name="notes">
                    </div>

                    <!-- Requested Date -->
                    <div class="mb-3">
                        <label for="requestedDate" class="form-label">
                            <i class="fas fa-calendar-day"></i> Preferred Date (Optional)
                        </label>
                        <input type="datetime-local" class="form-control" id="requestedDate" name="requestedDate">
                        <div class="form-text">We will try to schedule your consultation as close to this time as possible.</div>
                    </div>
                </div>

                <!-- Step 4: Review -->
                <div id="step4-content" class="step-content" style="display: none;">
                    <h5 class="mb-4">Review Your Request</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded mb-3">
                                <h6 class="text-primary"><i class="fas fa-user-md"></i> Selected Doctor</h6>
                                <p id="review-doctor" class="mb-0 font-weight-bold">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded mb-3">
                                <h6 class="text-primary"><i class="fas fa-video"></i> Consultation Type</h6>
                                <p id="review-type" class="mb-0 font-weight-bold">-</p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="p-3 bg-light rounded mb-3">
                                <h6 class="text-primary"><i class="fas fa-comment-medical"></i> Reason & Symptoms</h6>
                                <p id="review-reason" class="mb-1">-</p>
                                <div id="review-symptoms" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> After submission, the doctor will review your request and you will be notified once it's approved.
                    </div>
                </div>

            </div>
            <div class="card-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary ms-auto" id="nextBtn" onclick="changeStep(1)">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="submit" class="btn btn-success ms-auto" id="submitBtn" style="display: none;">
                    Submit Request <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentStep = 1;
    const totalSteps = 4;

    function changeStep(n ) {
        // Validation before moving forward
        if (n === 1) {
            if (currentStep === 1 && !document.getElementById('doctorId').value) {
                alert('Please select a doctor first.');
                return;
            }
            if (currentStep === 2 && !document.getElementById('consultationType').value) {
                alert('Please select a consultation type.');
                return;
            }
            if (currentStep === 3 && !document.getElementById('reason').value) {
                alert('Please provide a reason for the consultation.');
                return;
            }
        }

        // Hide current step
        document.getElementById(`step${currentStep}-content`).style.display = 'none';
        document.getElementById(`step${currentStep}`).classList.remove('active');
        if (n === 1) document.getElementById(`step${currentStep}`).classList.add('completed');

        // Update step
        currentStep += n;

        // Show new step
        document.getElementById(`step${currentStep}-content`).style.display = 'block';
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById(`step${currentStep}`).classList.remove('completed');

        // Update buttons
        document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
        document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'block';
        document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';

        // Update review step
        if (currentStep === 4) {
            updateReview();
        }
    }

    function selectDoctor(element) {
        // Remove selected class from all cards
        document.querySelectorAll('.doctor-card').forEach(card => card.classList.remove('selected'));
        // Add selected class to clicked card
        element.classList.add('selected');

        // Get data from attributes instead of passing parameters
        const doctorId = element.getAttribute('data-doctor-id');
        const doctorName = element.getAttribute('data-doctor-name');

        // Update hidden input
        document.getElementById('doctorId').value = doctorId;
        // Store doctor name for review
        document.getElementById('review-doctor').innerText = doctorName;
    }

    function selectType(element) {
        // Remove active class from all cards
        document.querySelectorAll('.consultation-type-card').forEach(card => card.classList.remove('active'));
        // Add active class to clicked card
        element.classList.add('active');

        // Get type from data attribute
        const type = element.getAttribute('data-type');

        // Update hidden input
        document.getElementById('consultationType').value = type;
        // Store type for review
        const typeLabel = element.querySelector('h6').innerText;
        document.getElementById('review-type').innerText = typeLabel;
    }
    function toggleSymptom(element) {
        element.classList.toggle('selected');
        const selectedSymptoms = Array.from(document.querySelectorAll('.symptom-tag.selected'))
            .map(tag => tag.innerText);
        document.getElementById('symptoms').value = selectedSymptoms.join(', ');
    }

    function updateReview() {
        document.getElementById('review-reason').innerText = document.getElementById('reason').value;
        const symptoms = document.getElementById('symptoms').value;
        const symptomsContainer = document.getElementById('review-symptoms');
        symptomsContainer.innerHTML = '';

        if (symptoms) {
            symptoms.split(', ').forEach(symptom => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info text-dark me-1';
                badge.innerText = symptom;
                symptomsContainer.appendChild(badge);
            });
        }
    }
</script>
</body>
</html>
