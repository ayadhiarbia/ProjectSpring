<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Dashboard - Telemedicine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .chat-container { max-width: 1000px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .sidebar { border-right: 1px solid #eee; height: 600px; overflow-y: auto; }
        .search-box { padding: 15px; border-bottom: 1px solid #eee; }
        .doctor-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; text-decoration: none; color: inherit; }
        .doctor-item:hover { background-color: #f0f7ff; }
        .doctor-avatar { width: 50px; height: 50px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; position: relative; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; position: absolute; bottom: 2px; right: 2px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #adb5bd; }
        .doctor-info { flex-grow: 1; }
        .doctor-name { font-weight: 600; margin-bottom: 2px; }
        .last-msg { font-size: 0.85rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .unread-badge { background-color: #dc3545; color: white; border-radius: 10px; padding: 2px 8px; font-size: 0.75rem; }
        .welcome-screen { height: 600px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #6c757d; }
        .debug-info { font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <!-- DEBUG HEADER - REMOVE AFTER FIXING -->
    <div class="alert alert-info mt-3 debug-info">
        <strong>Debug Info:</strong>
        Patient: <span th:text="${patient != null ? patient.name : 'Not logged in'}">N/A</span> |
        Doctors in model: <span th:text="${doctors != null ? doctors.size() : 0}">0</span> |
        Online users: <span th:text="${onlineUsers != null ? onlineUsers.size() : 0}">0</span>
    </div>

    <div class="chat-container row g-0">
        <!-- Sidebar: Doctor List -->
        <div class="col-md-4 sidebar">
            <div class="search-box">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="doctorSearch" class="form-control border-start-0" placeholder="Search doctors...">
                </div>
            </div>

            <div id="doctorList">
                <!-- SIMPLIFIED DOCTOR LIST - No complex conditions -->
                <div th:each="doctor : ${doctors}" class="doctor-list-item">
                    <a th:href="@{'/patient/chat/' + ${doctor.id}}" class="doctor-item">
                        <div class="doctor-avatar">
                            <span th:text="${#strings.substring(doctor.name, 0, 1)}">D</span>
                            <div class="status-indicator" th:classappend="${onlineUsers != null and onlineUsers.containsKey(doctor.id)
 ? 'status-online' : 'status-offline'}">
                            </div>
                        </div>
                        <div class="doctor-info">
                            <div class="doctor-name" th:text="'Dr. ' + ${doctor.name} + ' ' + ${doctor.prenom}">
                                Dr. Name
                            </div>
                            <div class="text-muted debug-info">
                                ID: <span th:text="${doctor.id}">0</span> |
                                Status: <span th:text="${doctor.status}">N/A</span>
                            </div>
                            <!-- SIMPLIFIED LAST MESSAGE - Always show something -->
                            <div class="last-msg">
                                <small class="text-muted">Click to start chatting</small>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- EMPTY STATE - Only show if doctors list is truly empty -->
                <div th:if="${doctors == null or doctors.isEmpty()}" class="text-center p-5">
                    <i class="bi bi-person-x" style="font-size: 3rem; color: #6c757d;"></i>
                    <h5 class="mt-3">No Doctors Available</h5>
                    <p class="text-muted">There are no approved doctors in the system.</p>

                    <!-- EXTRA DEBUG INFO -->
                    <div class="mt-3">
                        <small class="text-danger">
                            <strong>Debug - This should NOT show since we have doctors!</strong><br>
                            Patient: <span th:text="${patient != null ? patient.name : 'null'}"></span><br>
                            Doctors list: <span th:text="${doctors != null ? 'exists' : 'null'}"></span><br>
                            Doctors count: <span th:text="${doctors != null ? doctors.size() : 0}"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: Welcome -->
        <div class="col-md-8 d-none d-md-block">
            <div class="welcome-screen">
                <i class="bi bi-chat-dots" style="font-size: 4rem; opacity: 0.3;"></i>
                <h4 class="mt-3">Your Conversations</h4>
                <p>Select a doctor from the list to start chatting.</p>

                <!-- DEBUG: List all doctors -->
                <div class="mt-4 text-start p-3" style="background: #f8f9fa; border-radius: 5px; max-width: 400px;">
                    <h6>Debug - Doctors in Model:</h6>
                    <div th:if="${doctors != null}">
                        <div th:each="d : ${doctors}" class="mb-2">
                            <small>
                                <span th:text="${d.name}">Name</span>
                                (ID: <span th:text="${d.id}">0</span>)
                            </small>
                        </div>
                    </div>
                    <div th:if="${doctors == null}">
                        <small class="text-danger">Doctors list is NULL!</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    console.log("=== CHAT PAGE LOADED ===");
    console.log("Patient ID:", /*[[${patient != null ? patient.id : 'null'}]]*/ );
    console.log("Doctors count:", /*[[${doctors != null ? doctors.size() : 0}]]*/ );

    let stompClient = null;
    const patientId = /*[[${patient.id}]]*/ 0;

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            console.log('WebSocket Connected: ' + frame);

            // Notify server of connection
            stompClient.send("/app/chat.connect", {}, JSON.stringify({
                userId: patientId,
                sessionId: 'session-' + Math.random().toString(36).substr(2, 9),
                userRole: 'PATIENT'
            }));

            // Subscribe to status updates
            stompClient.subscribe('/topic/user.status', function (statusUpdate) {
                const status = JSON.parse(statusUpdate.body);
                console.log('Status update:', status);
                updateUserStatus(status.userId, status.isOnline);
            });

            // Subscribe to private messages
            stompClient.subscribe('/user/' + patientId + '/queue/messages', function (message) {
                console.log('New message received');
                // Refresh to update last message
                location.reload();
            });
        });
    }

    function updateUserStatus(userId, isOnline) {
        console.log('Updating status for user', userId, 'isOnline:', isOnline);
        const indicator = document.querySelector('.status-indicator[data-user="' + userId + '"]');
        if (indicator) {
            indicator.className = 'status-indicator ' + (isOnline ? 'status-online' : 'status-offline');
        }
    }

    // Search functionality
    document.getElementById('doctorSearch')?.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.doctor-list-item');
        items.forEach(item => {
            const nameElement = item.querySelector('.doctor-name');
            if (nameElement) {
                const name = nameElement.textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'block' : 'none';
            }
        });
    });

    window.onload = function() {
        console.log("Page loaded, doctors count:", document.querySelectorAll('.doctor-list-item').length);
        connect();
    };
    /*]]>*/
</script>
</body>
</html>