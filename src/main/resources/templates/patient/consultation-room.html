<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultation Room</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .consultation-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .consultation-header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-waiting {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Main Content */
        .consultation-main {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 20px;
            gap: 20px;
        }

        /* Video Container */
        .video-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-card {
            flex: 1;
            background-color: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
        }

        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .control-btn:hover {
            transform: scale(1.1);
        }
        .btn-mic {
            background-color: var(--success-color);
            color: white;
        }
        .btn-mic.muted {
            background-color: var(--danger-color);
        }
        .btn-camera {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-camera.off {
            background-color: var(--danger-color);
        }
        .btn-end {
            background-color: var(--danger-color);
            color: white;
        }

        /* Sidebar */
        .consultation-sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 400px;
        }

        .sidebar-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        /* Chat Section */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message-sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-received {
            align-self: flex-start;
            background-color: #f1f3f4;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }

        /* Participants Section */
        .participants-list {
            padding: 15px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 15px;
        }

        .doctor-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .patient-avatar {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        }

        /* Waiting Room */
        .waiting-room {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .waiting-icon {
            font-size: 4rem;
            color: var(--warning-color);
            margin-bottom: 20px;
        }

        .waiting-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #333;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .loading-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: pulse 1.5s infinite ease-in-out;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .consultation-main {
                flex-direction: column;
            }
            .consultation-sidebar {
                max-width: 100%;
                flex-direction: row;
            }
            .sidebar-card {
                min-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .consultation-sidebar {
                flex-direction: column;
            }
            .video-controls {
                flex-wrap: wrap;
                justify-content: center;
                width: 90%;
            }
            .control-btn {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
<div class="consultation-container">
    <!-- Header -->
    <div class="consultation-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">
                    <i class="fas fa-comments-medical text-primary"></i>
                    <span th:if="${consultationType == 'VIDEO_CALL'}">Video Consultation</span>
                    <span th:if="${consultationType == 'TEXT_CHAT'}">Text Consultation</span>
                    <span th:if="${consultationType == 'VOICE_CALL'}">Voice Consultation</span>
                </h4>
                <small class="text-muted">
                    with <strong th:text="'Dr. ' + ${doctor.name}">Dr. Name</strong>
                    | Room: <code th:text="${roomId}">room_id</code>
                </small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="status-indicator"
                     th:classappend="${isActive} ? 'status-active' : 'status-waiting'">
                    <i th:classappend="${isActive} ? 'fas fa-play-circle' : 'fas fa-clock'"></i>
                    <span th:text="${isActive} ? 'CONSULTATION ACTIVE' : 'WAITING FOR DOCTOR'">
                        Status
                    </span>
                </div>
                <div id="connectionStatus" class="text-success">
                    <i class="fas fa-wifi"></i> Connected
                </div>
                <button class="btn btn-outline-danger btn-sm" onclick="endConsultation()">
                    <i class="fas fa-sign-out-alt"></i> Leave
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="consultation-main">
        <!-- Waiting Room (shown when consultation is not active) -->
        <div th:if="${isInWaitingRoom}" class="waiting-room" style="flex: 1; display: flex; align-items: center; justify-content: center;">
            <div>
                <div class="waiting-icon">
                    <i class="fas fa-user-clock"></i>
                </div>
                <h3 class="waiting-message">Waiting for Doctor to Start Consultation</h3>
                <p class="text-muted mb-4">
                    Please wait while the doctor prepares to start the consultation.
                    You'll be connected automatically when they're ready.
                </p>

                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>

                <div class="mt-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Doctor:</strong>
                        <span th:text="'Dr. ' + ${doctor.name}">Dr. Name</span>
                        <br>
                        <strong>Consultation Type:</strong>
                        <span th:text="${consultationType}">Type</span>
                    </div>

                    <button class="btn btn-primary mt-3" onclick="checkStatus()">
                        <i class="fas fa-sync-alt"></i> Check Status
                    </button>
                </div>
            </div>
        </div>

        <!-- Consultation Room (shown when active) -->
        <div th:unless="${isInWaitingRoom}" style="flex: 1; display: flex; width: 100%; gap: 20px;">
            <!-- Video Container -->
            <div class="video-container" th:if="${consultationType == 'VIDEO_CALL' or consultationType == 'VOICE_CALL'}">
                <!-- Doctor's Video -->
                <div class="video-card">
                    <div id="remoteVideoContainer" class="video-placeholder">
                        <i class="fas fa-user-md fa-4x"></i>
                        <p class="mt-3">Waiting for doctor's video...</p>
                    </div>
                    <div class="video-controls">
                        <button id="toggleMic" class="control-btn btn-mic" onclick="toggleMic()">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button id="toggleCamera" class="control-btn btn-camera" onclick="toggleCamera()"
                                th:if="${consultationType == 'VIDEO_CALL'}">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="control-btn btn-end" onclick="endConsultation()">
                            <i class="fas fa-phone-slash"></i>
                        </button>
                    </div>
                </div>

                <!-- Patient's Video (Self View) -->
                <div class="video-card" th:if="${consultationType == 'VIDEO_CALL'}" style="flex: 0.5;">
                    <div id="localVideoContainer" class="video-placeholder">
                        <i class="fas fa-user fa-3x"></i>
                        <p class="mt-2">Your camera</p>
                    </div>
                </div>
            </div>

            <!-- Text Chat Interface -->
            <div th:if="${consultationType == 'TEXT_CHAT'}" class="video-container">
                <div class="sidebar-card" style="flex: 1;">
                    <div class="sidebar-header">
                        <i class="fas fa-comments"></i> Text Consultation Chat
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message message-received">
                            <div class="message-content">
                                Hello! This is Dr. <span th:text="${doctor.name}">Name</span>.
                                How can I help you today?
                            </div>
                            <div class="message-time">10:00 AM</div>
                        </div>
                        <div class="message message-sent">
                            <div class="message-content">
                                Hi Doctor, I've been experiencing headaches for the past few days.
                            </div>
                            <div class="message-time">10:01 AM</div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" class="form-control" id="chatInput"
                               placeholder="Type your message here..."
                               onkeypress="handleChatInput(event)">
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="consultation-sidebar">
                <!-- Participants -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="fas fa-users"></i> Participants
                    </div>
                    <div class="participants-list">
                        <div class="participant-item">
                            <div class="participant-avatar doctor-avatar">
                                DR
                            </div>
                            <div>
                                <h6 class="mb-1" th:text="'Dr. ' + ${doctor.name}">Dr. Name</h6>
                                <small class="text-muted">Doctor</small>
                            </div>
                            <div class="ms-auto">
                                <span class="badge bg-success">
                                    <i class="fas fa-microphone"></i>
                                    <i class="fas fa-video"></i>
                                </span>
                            </div>
                        </div>
                        <div class="participant-item">
                            <div class="participant-avatar patient-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" th:text="${patient.name}">Patient Name</h6>
                                <small class="text-muted">You</small>
                            </div>
                            <div class="ms-auto">
                                <span id="patientStatus" class="badge bg-success">
                                    <i class="fas fa-microphone"></i>
                                    <i th:if="${consultationType == 'VIDEO_CALL'}" class="fas fa-video"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="fas fa-comment-dots"></i> Chat
                    </div>
                    <div class="chat-messages" id="sidebarChat">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" class="form-control" id="sidebarChatInput"
                               placeholder="Type a message..." aria-label="Chat message input">
                        <button class="btn btn-primary" onclick="sendSidebarMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- Tools & Files -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="fas fa-tools"></i> Tools
                    </div>
                    <div class="p-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" onclick="shareScreen()">
                                    <i class="fas fa-desktop"></i> Share Screen
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success w-100" onclick="uploadFile()">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info w-100" onclick="takeNotes()">
                                    <i class="fas fa-sticky-note"></i> Take Notes
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-warning w-100" onclick="toggleTimer()">
                                    <i class="fas fa-clock"></i> Timer
                                </button>
                            </div>
                        </div>

                        <!-- Timer Display -->
                        <div id="timerDisplay" class="mt-3 text-center" style="display: none;">
                            <h3 id="timer">00:00</h3>
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetTimer()">
                                Reset
                            </button>
                        </div>

                        <!-- File Upload -->
                        <div id="fileUpload" class="mt-3" style="display: none;">
                            <label for="fileInput" class="form-label visually-hidden">Select files to upload</label>
                            <input type="file" class="form-control" id="fileInput" multiple aria-label="Select files to upload">
                            <button class="btn btn-sm btn-success mt-2" onclick="sendFiles()">
                                Send Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebRTC Configuration (hidden) -->
<div style="display: none;">
    <input id="roomId" th:value="${roomId}">
    <input id="consultationId" th:value="${consultation.id}">
    <input id="userId" th:value="${patient.id}">
    <input id="doctorId" th:value="${doctor.id}">
    <input id="stunServers" th:value="${stunServers}">
    <input id="turnServers" th:value="${turnServers}">
    <input id="consultationTypeHidden" th:value="${consultationType}">
    <input id="isInWaitingRoomHidden" th:value="${isInWaitingRoom}">
    <input id="patientNameHidden" th:value="${patient.name}">
    <input id="doctorNameHidden" th:value="${doctor.name}">
</div>

<!-- WebSocket Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    // Get data from hidden inputs
    const roomId = document.getElementById('roomId').value;
    const consultationId = document.getElementById('consultationId').value;
    const userId = document.getElementById('userId').value;
    const doctorId = document.getElementById('doctorId').value;
    const consultationType = document.getElementById('consultationTypeHidden').value;
    const isInWaitingRoom = document.getElementById('isInWaitingRoomHidden').value === 'true';
    const patientName = document.getElementById('patientNameHidden').value;
    const doctorName = document.getElementById('doctorNameHidden').value;

    // WebRTC Configuration
    const config = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" }
        ]
    };

    // Global variables
    let peerConnection;
    let localStream;
    let remoteStream;
    let isMicOn = true;
    let isCameraOn = true;
    let chatMessages = [];
    let consultationTimer;
    let secondsElapsed = 0;
    let stompClient = null;

    // WebSocket Connection
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);

            // Subscribe to consultation events
            stompClient.subscribe('/user/' + userId + '/queue/consultation', function(message) {
                const event = JSON.parse(message.body);
                handleConsultationEvent(event);
            });

            // Subscribe to chat messages
            stompClient.subscribe('/topic/consultation/' + roomId + '/chat', function(message) {
                const chatMessage = JSON.parse(message.body);
                displayMessage(chatMessage);
            });

            // Subscribe to WebRTC signals
            stompClient.subscribe('/user/' + userId + '/queue/signal', function(message) {
                const signal = JSON.parse(message.body);
                handleSignal(signal);
            });

            // Notify that patient is ready
            sendEvent('PATIENT_READY', 'Patient is ready for consultation');
        });
    }

    // Send WebSocket event
    function sendEvent(eventType, description) {
        if (stompClient && stompClient.connected) {
            const event = {
                eventType: eventType,
                consultationId: consultationId,
                userId: userId,
                description: description,
                timestamp: new Date().toISOString()
            };
            stompClient.send('/app/consultation.event', {}, JSON.stringify(event));
        }
    }

    // Handle consultation events
    function handleConsultationEvent(event) {
        console.log('Event received:', event);

        switch(event.eventType) {
            case 'CONSULTATION_STARTED':
                startConsultation();
                break;
            case 'CONSULTATION_ENDED':
                endConsultation(true);
                break;
            case 'DOCTOR_JOINED':
                updateStatus('Doctor joined the consultation');
                break;
            case 'PATIENT_WAITING_ACK':
                updateStatus('Doctor acknowledged your waiting');
                break;
        }
    }

    // Initialize WebRTC
    async function initWebRTC() {
        try {
            // Get local media stream
            const constraints = {
                audio: true,
                video: consultationType === 'VIDEO_CALL'
            };

            localStream = await navigator.mediaDevices.getUserMedia(constraints);

            // Display local video
            const localVideo = document.createElement('video');
            localVideo.srcObject = localStream;
            localVideo.autoplay = true;
            localVideo.muted = true;

            const localContainer = document.getElementById('localVideoContainer');
            if (localContainer) {
                localContainer.innerHTML = '';
                localContainer.appendChild(localVideo);
            }

            // Create peer connection
            peerConnection = new RTCPeerConnection(config);

            // Add local stream to peer connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle remote stream
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = remoteStream;
                remoteVideo.autoplay = true;

                const remoteContainer = document.getElementById('remoteVideoContainer');
                if (remoteContainer) {
                    remoteContainer.innerHTML = '';
                    remoteContainer.appendChild(remoteVideo);
                }
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignal({
                        type: 'candidate',
                        candidate: event.candidate,
                        targetUserId: doctorId
                    });
                }
            };

            // Handle connection state
            peerConnection.onconnectionstatechange = () => {
                updateConnectionStatus(peerConnection.connectionState);
            };

        } catch (error) {
            console.error('Error accessing media devices:', error);
            alert('Could not access camera/microphone. Please check permissions.');
        }
    }

    // Send WebRTC signal
    function sendSignal(signal) {
        if (stompClient && stompClient.connected) {
            signal.roomId = roomId;
            signal.senderId = userId;
            stompClient.send('/app/consultation.signal', {}, JSON.stringify(signal));
        }
    }

    // Handle incoming signals
    function handleSignal(signal) {
        if (!peerConnection) return;

        switch(signal.type) {
            case 'offer':
                handleOffer(signal);
                break;
            case 'answer':
                handleAnswer(signal);
                break;
            case 'candidate':
                handleCandidate(signal);
                break;
        }
    }

    async function handleOffer(signal) {
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            sendSignal({
                type: 'answer',
                answer: answer,
                targetUserId: doctorId
            });
        } catch (error) {
            console.error('Error handling offer:', error);
        }
    }

    async function handleAnswer(signal) {
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.answer));
        } catch (error) {
            console.error('Error handling answer:', error);
        }
    }

    async function handleCandidate(signal) {
        try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
        } catch (error) {
            console.error('Error handling ICE candidate:', error);
        }
    }

    // Start consultation
    function startConsultation() {
        updateStatus('Consultation started!');
        const waitingRoom = document.querySelector('.waiting-room');
        const consultationRoom = document.querySelector('.consultation-main > div:not(.waiting-room)');

        if (waitingRoom) waitingRoom.style.display = 'none';
        if (consultationRoom) consultationRoom.style.display = 'flex';

        // Start timer
        startTimer();

        // Initialize WebRTC for video/voice consultation
        if (consultationType === 'VIDEO_CALL' || consultationType === 'VOICE_CALL') {
            initWebRTC();
        }

        // Send welcome message
        sendMessage('Patient has joined the consultation');
    }

    // Toggle microphone
    function toggleMic() {
        if (localStream) {
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => {
                track.enabled = !track.enabled;
            });
            isMicOn = !isMicOn;

            const micBtn = document.getElementById('toggleMic');
            if (micBtn) {
                micBtn.classList.toggle('muted', !isMicOn);
                micBtn.innerHTML = isMicOn ? '<i class="fas fa-microphone"></i>' :
                    '<i class="fas fa-microphone-slash"></i>';
            }

            updatePatientStatus();
        }
    }

    // Toggle camera
    function toggleCamera() {
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => {
                track.enabled = !track.enabled;
            });
            isCameraOn = !isCameraOn;

            const cameraBtn = document.getElementById('toggleCamera');
            if (cameraBtn) {
                cameraBtn.classList.toggle('off', !isCameraOn);
                cameraBtn.innerHTML = isCameraOn ? '<i class="fas fa-video"></i>' :
                    '<i class="fas fa-video-slash"></i>';
            }

            updatePatientStatus();
        }
    }

    // Update patient status badge
    function updatePatientStatus() {
        const statusBadge = document.getElementById('patientStatus');
        if (statusBadge) {
            let html = '';
            if (isMicOn) html += '<i class="fas fa-microphone"></i> ';
            if (isCameraOn && consultationType === 'VIDEO_CALL') html += '<i class="fas fa-video"></i>';
            statusBadge.innerHTML = html || '<i class="fas fa-ban"></i>';
        }
    }

    // Update connection status
    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
            switch(status) {
                case 'connected':
                    statusElement.innerHTML = '<i class="fas fa-wifi text-success"></i> Connected';
                    break;
                case 'disconnected':
                    statusElement.innerHTML = '<i class="fas fa-wifi-slash text-danger"></i> Disconnected';
                    break;
                case 'failed':
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Connection Failed';
                    break;
                case 'closed':
                    statusElement.innerHTML = '<i class="fas fa-power-off text-secondary"></i> Closed';
                    break;
            }
        }
    }

    // Chat functionality
    function sendMessage(content) {
        if (stompClient && stompClient.connected) {
            const message = {
                roomId: roomId,
                senderId: userId,
                senderName: patientName,
                content: content,
                timestamp: new Date().toISOString(),
                type: 'text'
            };

            stompClient.send('/app/consultation.chat', {}, JSON.stringify(message));

            // Display message locally
            displayMessage({
                ...message,
                isSent: true
            });

            const chatInput = document.getElementById('chatInput');
            const sidebarChatInput = document.getElementById('sidebarChatInput');
            if (chatInput) chatInput.value = '';
            if (sidebarChatInput) sidebarChatInput.value = '';
        }
    }

    function sendSidebarMessage() {
        const input = document.getElementById('sidebarChatInput');
        if (input && input.value.trim()) {
            sendMessage(input.value.trim());
        }
    }

    function handleChatInput(event) {
        if (event.key === 'Enter') {
            sendMessage(event.target.value);
        }
    }

    function displayMessage(message) {
        const isSent = message.senderId == userId;
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isSent ? 'message-sent' : 'message-received'}`;

        const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        messageElement.innerHTML = `
            <div class="message-content">${message.content}</div>
            <div class="message-time">${time} ${isSent ? '' : 'â€¢ ' + message.senderName}</div>
        `;

        // Add to both chat containers
        const chatMessagesContainer = document.getElementById('chatMessages');
        const sidebarChatContainer = document.getElementById('sidebarChat');

        if (chatMessagesContainer) {
            chatMessagesContainer.appendChild(messageElement.cloneNode(true));
        }
        if (sidebarChatContainer) {
            sidebarChatContainer.appendChild(messageElement);
        }

        // Scroll to bottom
        const containers = ['chatMessages', 'sidebarChat'];
        containers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        });

        // Store message
        chatMessages.push(message);
    }

    // Timer functions
    function startTimer() {
        consultationTimer = setInterval(() => {
            secondsElapsed++;
            const minutes = Math.floor(secondsElapsed / 60);
            const seconds = secondsElapsed % 60;
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }

    function toggleTimer() {
        const display = document.getElementById('timerDisplay');
        if (display) {
            display.style.display = display.style.display === 'none' ? 'block' : 'none';
        }
    }

    function resetTimer() {
        secondsElapsed = 0;
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = '00:00';
        }
    }

    // File upload
    function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.click();
        }
    }

    function sendFiles() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput && fileInput.files.length > 0) {
            // In a real implementation, you would upload files to server
            // and send file metadata via WebSocket
            alert(`${fileInput.files.length} file(s) selected. Upload functionality would be implemented here.`);

            // Hide upload UI
            const fileUploadDiv = document.getElementById('fileUpload');
            if (fileUploadDiv) {
                fileUploadDiv.style.display = 'none';
            }
        }
    }

    // Check consultation status
    function checkStatus() {
        fetch(`/patient/consultation/join/${consultationId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.consultationActive) {
                        startConsultation();
                    } else {
                        alert('Doctor is not ready yet. Please wait.');
                    }
                }
            });
    }

    // End consultation
    function endConsultation(isForced = false) {
        if (isForced || confirm('Are you sure you want to leave the consultation?')) {
            // Stop media streams
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
            }

            // Stop timer
            if (consultationTimer) {
                clearInterval(consultationTimer);
            }

            // Disconnect WebSocket
            if (stompClient) {
                stompClient.disconnect();
            }

            // Redirect
            window.location.href = `/patient/consultation/summary/${consultationId}`;
        }
    }

    // Share screen
    function shareScreen() {
        if (navigator.mediaDevices.getDisplayMedia) {
            navigator.mediaDevices.getDisplayMedia({ video: true })
                .then(stream => {
                    // Replace video track
                    const videoTrack = stream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => s.track?.kind === 'video');
                    if (sender) {
                        sender.replaceTrack(videoTrack);
                    }
                })
                .catch(error => {
                    console.error('Error sharing screen:', error);
                });
        } else {
            alert('Screen sharing is not supported in your browser.');
        }
    }

    // Take notes
    function takeNotes() {
        const notes = prompt('Enter your notes for this consultation:');
        if (notes) {
            // Save notes locally (in real implementation, send to server)
            localStorage.setItem(`consultation_notes_${consultationId}`, notes);
            alert('Notes saved!');
        }
    }

    // Update status message
    function updateStatus(message) {
        const statusElement = document.querySelector('.status-indicator');
        if (statusElement) {
            statusElement.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;

            // Show temporary notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
            notification.innerHTML = `
                <i class="fas fa-info-circle"></i> ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        updatePatientStatus();

        // Auto-check status every 10 seconds if in waiting room
        if (isInWaitingRoom) {
            setInterval(checkStatus, 10000);
        }

        // Handle file input change
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const fileUploadDiv = document.getElementById('fileUpload');
                if (fileUploadDiv) {
                    fileUploadDiv.style.display = 'block';
                }
            });
        }

        // Add sample chat messages
        setTimeout(() => {
            if (consultationType === 'TEXT_CHAT') {
                displayMessage({
                    senderId: doctorId,
                    senderName: 'Dr. ' + doctorName,
                    content: 'Hello! This is Dr. ' + doctorName + '. How can I help you today?',
                    timestamp: new Date().toISOString(),
                    isSent: false
                });
            }
        }, 1000);
    });

    // Handle page unload
    window.addEventListener('beforeunload', function(e) {
        if (peerConnection || localStream) {
            e.preventDefault();
            e.returnValue = 'Are you sure you want to leave the consultation?';
            endConsultation(true);
        }
    });
</script>
</body>
</html>